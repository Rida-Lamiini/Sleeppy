"use strict";var D=Object.create;var R=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var G=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of q(t))!H.call(e,o)&&o!==r&&R(e,o,{get:()=>t[o],enumerable:!(n=F(t,o))||n.enumerable});return e};var J=(e,t,r)=>(r=e!=null?D(B(e)):{},G(t||!e||!e.__esModule?R(r,"default",{value:e,enumerable:!0}):r,e));Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});var L=(e=>(e.email="email",e.profile="profile",e.openid="openid",e.offline_access="offline",e))(L||{}),T=(e=>(e.none="none",e.create="create",e.login="login",e))(T||{}),w=(e=>(e.logout="logout",e.login="login",e.register="registration",e.token="token",e.profile="profile",e))(w||{});const O=e=>{const t=s=>btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");if(e instanceof ArrayBuffer){const s=new Uint8Array(e),f=String.fromCharCode(...s);return t(f)}const n=new TextEncoder().encode(e),o=String.fromCharCode(...n);return t(o)},y=(e=28)=>{if(crypto){const t=new Uint8Array(e/2);return crypto.getRandomValues(t),Array.from(t,W).join("")}else return Z(e)};function W(e){return e.toString(16).padStart(2,"0")}function Z(e=28){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let r="";const n=t.length;for(let o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*n));return r}const Q=e=>{e=e.split("?")[1];const t=new URLSearchParams(e);return{accessToken:t.get("access_token"),idToken:t.get("id_token"),expiresIn:+(t.get("expires_in")||0)}},P=e=>e.replace(/\/$/,""),j=e=>{const t={login_hint:e.loginHint,is_create_org:e.isCreateOrg?.toString(),connection_id:e.connectionId,redirect_uri:e.redirectURL?P(e.redirectURL):void 0,audience:e.audience||"",scope:e.scope?.join(" ")||"email profile openid offline",prompt:e.prompt,lang:e.lang,org_code:e.orgCode,org_name:e.orgName,has_success_page:e.hasSuccessPage?.toString(),workflow_deployment_id:e.workflowDeploymentId};return Object.keys(t).forEach(r=>t[r]===void 0&&delete t[r]),t},X=async(e,t=w.login,r)=>{const n=new URL(`${e}/oauth2/auth`),o=U(),s={client_id:r.clientId,response_type:r.responseType||"code",...j(r)};if(r.state||(r.state=y(32),o&&o.setSessionItem(i.state,r.state)),s.state=r.state,r.nonce||(r.nonce=y(16)),s.nonce=r.nonce,o&&o.setSessionItem(i.nonce,r.nonce),r.codeChallenge)s.code_challenge=r.codeChallenge;else{const{codeVerifier:f,codeChallenge:d}=await Y();o&&o.setSessionItem(i.codeVerifier,f),s.code_challenge=d}return s.code_challenge_method="S256",r.codeChallengeMethod&&(s.code_challenge_method=r.codeChallengeMethod),!r.prompt&&t===w.register&&(s.prompt=T.create),n.search=new URLSearchParams(s).toString(),{url:n,state:s.state,nonce:s.nonce,codeChallenge:s.code_challenge}};async function Y(){const e=y(52),t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=O(r);return{codeVerifier:e,codeChallenge:n}}let S;function M(e,t){if(C(),typeof window>"u")throw new Error("setRefreshTimer requires a browser environment");if(e<=0)throw new Error("Timer duration must be positive");S=window.setTimeout(t,e*1e3-1e4)}function C(){S!==void 0&&(window.clearTimeout(S),S=void 0)}const h={framework:"",frameworkVersion:""},K=async({urlParams:e,domain:t,clientId:r,redirectURL:n,autoRefresh:o=!1})=>{const s=e.get("state"),f=e.get("code");if(!s||!f)return console.error("Invalid state or code"),{success:!1,error:"Invalid state or code"};const d=U();if(!d)return console.error("No active storage found"),{success:!1,error:"Authentication storage is not initialized"};(!h.framework||!h.frameworkVersion)&&console.warn("Framework and version not set. Please set the framework and version in the config object");const E=await d.getSessionItem(i.state);if(s!==E)return console.error("Invalid state"),{success:!1,error:`Invalid state; supplied ${s}, expected ${E}`};const V=await d.getSessionItem(i.codeVerifier),b={"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Cache-Control":"no-store",Pragma:"no-cache"};h.framework&&(b["Kinde-SDK"]=`${h.framework}/${h.frameworkVersion}`);const m=await fetch(`${t}/oauth2/token`,{method:"POST",headers:new Headers(b),body:new URLSearchParams({client_id:r,code:f,code_verifier:V,grant_type:"authorization_code",redirect_uri:n})});if(!m?.ok){const k=await m.text();return console.error("Token exchange failed:",m.status,k),{success:!1,error:`Token exchange failed: ${m.status} - ${k}`}}C();const g=await m.json();I().setItems({[i.accessToken]:g.access_token,[i.idToken]:g.id_token,[i.refreshToken]:g.refresh_token}),o&&M(g.expires_in,async()=>{v(t,r)}),await d.removeItems(i.state,i.nonce,i.codeVerifier);const z=(k=>(k.search="",k))(new URL(window.location.toString()));return window.history.replaceState(window.history.state,"",z),{success:!0,[i.accessToken]:g.access_token,[i.idToken]:g.id_token,[i.refreshToken]:g.refresh_token}},ee=e=>!e.match("^[a-zA-Z]*.kinde.com");var i=(e=>(e.accessToken="accessToken",e.idToken="idToken",e.refreshToken="refreshToken",e.state="state",e.nonce="nonce",e.codeVerifier="codeVerifier",e))(i||{});class ${async setItems(t){await Promise.all(Object.entries(t).map(([r,n])=>this.setSessionItem(r,n)))}async removeItems(...t){await Promise.all(t.map(r=>this.removeSessionItem(r)))}}function x(e,t){return t<=0?[]:e.match(new RegExp(`.{1,${t}}`,"g"))||[]}class te extends ${memCache={};async destroySession(){this.memCache={}}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){x(r,a.maxLength).forEach((n,o)=>{this.memCache[`${a.keyPrefix}${t}${o}`]=n});return}this.memCache[`${a.keyPrefix}${String(t)}0`]=r}async getSessionItem(t){if(this.memCache[`${a.keyPrefix}${String(t)}0`]===void 0)return null;let r="",n=0,o=`${a.keyPrefix}${String(t)}${n}`;for(;this.memCache[o]!==void 0;)r+=this.memCache[o],n++,o=`${a.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){for(const r in this.memCache)r.startsWith(`${a.keyPrefix}${String(t)}`)&&delete this.memCache[r]}}function _(e){return new Promise((t,r)=>{chrome.storage.local.get([e],function(n){chrome.runtime.lastError?r(void 0):t(n[e])})})}class re extends ${async destroySession(){await chrome.storage.local.clear()}async setSessionItem(t,r){if(await this.removeSessionItem(t),typeof r=="string"){x(r,a.maxLength).forEach(async(n,o)=>{await chrome.storage.local.set({[`${a.keyPrefix}${t}${o}`]:n})});return}await chrome.storage.local.set({[`${a.keyPrefix}${t}0`]:r})}async getSessionItem(t){let r="",n=0,o=`${a.keyPrefix}${String(t)}${n}`;for(;await _(`${a.keyPrefix}${String(t)}${n}`)!==void 0;)r+=await _(o),n++,o=`${a.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;await _(`${a.keyPrefix}${String(t)}${r}`)!==void 0;)await chrome.storage.local.remove(`${a.keyPrefix}${String(t)}${r}`),r++}}let l;async function p(){let e=0;for(;!l&&e<20;)await new Promise(t=>setTimeout(t,100)),e++}class ne extends ${constructor(){super(),this.loadExpoStore()}async loadExpoStore(){try{l=await import("expo-secure-store")}catch(t){console.error("Error loading dependency expo storage:",t)}}async destroySession(){Object.values(i).forEach(async r=>{await this.removeSessionItem(r)})}async setSessionItem(t,r){if(await p(),await this.removeSessionItem(t),typeof r=="string"){x(r,Math.min(a.maxLength,2048)).forEach(async(n,o)=>{await l.setItemAsync(`${a.keyPrefix}${t}${o}`,n)});return}else throw new Error("Item value must be a string")}async getSessionItem(t){await p();const r=[];let n=0,o=await l.getItemAsync(`${a.keyPrefix}${String(t)}${n}`);for(;o;)r.push(o),n++,o=await l.getItemAsync(`${a.keyPrefix}${String(t)}${n}`);return r.join("")||null}async removeSessionItem(t){await p();let r=0,n=await l.getItemAsync(`${a.keyPrefix}${String(t)}${r}`);for(;n;)await l.deleteItemAsync(`${a.keyPrefix}${String(t)}${r}`),r++,n=await l.getItemAsync(`${a.keyPrefix}${String(t)}${r}`)}}class oe extends ${constructor(){super(),console.warn("LocalStorage store should not be used in production")}internalItems=new Set;async destroySession(){this.internalItems.forEach(t=>{this.removeSessionItem(t)})}async setSessionItem(t,r){if(await this.removeSessionItem(t),this.internalItems.add(t),typeof r=="string"){x(r,a.maxLength).forEach((n,o)=>{localStorage.setItem(`${a.keyPrefix}${t}${o}`,n)});return}localStorage.setItem(`${a.keyPrefix}${t}0`,r)}async getSessionItem(t){if(localStorage.getItem(`${a.keyPrefix}${t}0`)===null)return null;let r="",n=0,o=`${a.keyPrefix}${String(t)}${n}`;for(;localStorage.getItem(o)!==null;)r+=localStorage.getItem(o),n++,o=`${a.keyPrefix}${String(t)}${n}`;return r}async removeSessionItem(t){let r=0;for(;localStorage.getItem(`${a.keyPrefix}${String(t)}${r}`)!==null;)localStorage.removeItem(`${a.keyPrefix}${String(t)}${r}`),r++;this.internalItems.delete(t)}}const a={keyPrefix:"kinde-",maxLength:2e3};function se(e,t){if(!e)return null;const r=e.split(".");if(r.length!==3)return null;const n=r[1].replace(/-/g,"+").replace(/_/g,"/"),o=decodeURIComponent(atob(n).split("").map(s=>"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(o)}const u=async(e=i.accessToken)=>{const t=I();if(!t)return null;const r=await t.getSessionItem(e==="accessToken"?i.accessToken:i.idToken);if(!r)return null;const n=se(r);return n||console.warn("No decoded token found"),n},N=async()=>u("accessToken"),A=async e=>{const t=await N();return t?{name:e,value:t[e]}:null},ae=async()=>(await A("org_code"))?.value||null,ie=async e=>{const t=(await A("feature_flags"))?.value;return e&&t&&t[e]?.v||null},ce=async()=>{const e=await u("idToken");if(!e)return null;const{sub:t}=e;return t?{id:e.sub,givenName:e.given_name,familyName:e.family_name,email:e.email,picture:e.picture}:(console.error("No sub in idToken"),null)},le=async e=>{const t=await u();if(!t)return{permissionKey:e,orgCode:null,isGranted:!1};const r=t.permissions||[];return{permissionKey:e,orgCode:t.org_code,isGranted:!!r.includes(e)}},ue=async()=>{const e=await u();if(!e)return{orgCode:null,permissions:[]};const t=e.permissions||[];return{orgCode:e.org_code,permissions:t}},ge=async()=>(await u("idToken"))?.org_codes||null,fe=async()=>{const e=await u();return e?e.roles?e.roles:(console.warn("No roles found in token, ensure roles have been included in the token customisation within the application settings"),[]):[]},de=async e=>{try{const t=await u("accessToken");if(!t)return!1;if(!t.exp)return console.error("Token does not have an expiry"),!1;const r=t.exp<Math.floor(Date.now()/1e3);return r&&e?.useRefreshToken?(await v(e.domain,e.clientId)).success:!r}catch(t){return console.error("Error checking authentication:",t),!1}},v=async(e,t)=>{try{if(!e)return{success:!1,error:"Domain is required for token refresh"};if(!t)return{success:!1,error:"Client ID is required for token refresh"};const r=I();if(!r)return{success:!1,error:"No active storage found"};const n=await r.getSessionItem(i.refreshToken);if(!n)return{success:!1,error:"No refresh token found"};C();const o=await fetch(`${P(e)}/oauth2/token`,{method:"POST",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Cache-Control":"no-store",Pragma:"no-cache"},body:new URLSearchParams({refresh_token:n,grant_type:"refresh_token",client_id:t})});if(!o.ok)return{success:!1,error:"Failed to refresh token"};const s=await o.json();return s.access_token?(M(s.expires_in,async()=>{v(e,t)}),await r.setSessionItem(i.accessToken,s.access_token),s.id_token&&await r.setSessionItem(i.idToken,s.id_token),s.refresh_token&&await r.setSessionItem(i.refreshToken,s.refresh_token),{success:!0,[i.accessToken]:s.access_token,[i.idToken]:s.id_token,[i.refreshToken]:s.refresh_token}):{success:!1,error:"No access token recieved"}}catch(r){return{success:!1,error:`Error refreshing token: ${r}`}}},c={secure:null,insecure:null},he=e=>{c.secure=e},I=()=>c.secure||null,me=()=>c.secure!==null,ke=()=>{c.secure=null},Se=e=>{c.insecure=e},U=()=>c.insecure||c.secure||null,we=()=>c.insecure!==null,ye=()=>{c.insecure=null};exports.ChromeStore=re;exports.ExpoSecureStore=ne;exports.IssuerRouteTypes=w;exports.LocalStorage=oe;exports.MemoryStorage=te;exports.PromptTypes=T;exports.Scopes=L;exports.StorageKeys=i;exports.base64UrlEncode=O;exports.clearActiveStorage=ke;exports.clearInsecureStorage=ye;exports.exchangeAuthCode=K;exports.extractAuthResults=Q;exports.frameworkSettings=h;exports.generateAuthUrl=X;exports.generateRandomString=y;exports.getActiveStorage=I;exports.getClaim=A;exports.getClaims=N;exports.getCurrentOrganization=ae;exports.getDecodedToken=u;exports.getFlag=ie;exports.getInsecureStorage=U;exports.getPermission=le;exports.getPermissions=ue;exports.getRoles=fe;exports.getUserOrganizations=ge;exports.getUserProfile=ce;exports.hasActiveStorage=me;exports.hasInsecureStorage=we;exports.isAuthenticated=de;exports.isCustomDomain=ee;exports.mapLoginMethodParamsForUrl=j;exports.refreshToken=v;exports.sanitizeUrl=P;exports.setActiveStorage=he;exports.setInsecureStorage=Se;exports.storageSettings=a;
